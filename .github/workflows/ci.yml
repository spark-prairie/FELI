# ðŸ”— Links:
# Consolidated CI pipeline for FELI App

# âœï¸ Description:
# This action runs on all Pull Requests to main and develop branches.
# It performs comprehensive checks:
#   - Expo Doctor (project health verification)
#   - Linting (ESLint + Prettier)
#   - Type Checking (TypeScript)
#   - Unit Tests (Jest with coverage)

# ðŸš¨ GITHUB SECRETS REQUIRED: NONE

name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # Job 1: Expo Doctor - Verify Project Health
  # ============================================
  expo-doctor:
    name: ðŸ¥ Expo Doctor
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout project repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node + PNPM + install deps
        uses: ./.github/actions/setup-node-pnpm-install

      - name: ðŸ¥ Run Expo Doctor
        run: npx expo-doctor@latest

  # ============================================
  # Job 2: Lint - ESLint + Prettier
  # ============================================
  lint:
    name: ðŸ§¹ Lint (ESLint, Prettier)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout project repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node + PNPM + install deps
        uses: ./.github/actions/setup-node-pnpm-install

      - name: ðŸƒâ€â™‚ï¸ Run ESLint (PR with annotations)
        if: github.event_name == 'pull_request'
        uses: reviewdog/action-eslint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          eslint_flags: '. --ext .js,.jsx,.ts,.tsx'

      - name: ðŸƒâ€â™‚ï¸ Run ESLint (Push)
        if: github.event_name != 'pull_request'
        run: pnpm run lint

  # ============================================
  # Job 3: Type Check - TypeScript
  # ============================================
  type-check:
    name: ðŸ” Type Check (TSC)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout project repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node + PNPM + install deps
        uses: ./.github/actions/setup-node-pnpm-install

      - name: ðŸ“¦ Install Reviewdog
        if: github.event_name == 'pull_request'
        uses: reviewdog/action-setup@v1

      - name: ðŸƒâ€â™‚ï¸ Run TypeScript (PR with annotations)
        if: github.event_name == 'pull_request'
        run: |
          pnpm type-check | reviewdog -name="tsc" -efm="%f(%l,%c): error TS%n: %m" -reporter="github-pr-review" -filter-mode="nofilter" -fail-on-error -tee
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸƒâ€â™‚ï¸ Run TypeScript (Push)
        if: github.event_name != 'pull_request'
        run: pnpm type-check

  # ============================================
  # Job 4: Unit Tests - Jest
  # ============================================
  test:
    name: ðŸ§ª Tests (Jest)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout project repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node + PNPM + install deps
        uses: ./.github/actions/setup-node-pnpm-install

      - name: ðŸƒâ€â™‚ï¸ Run Tests
        run: pnpm run test:ci

      - name: ðŸ’¯ Jest Coverage Comment
        uses: MishaKav/jest-coverage-comment@main
        if: (success() || failure()) && github.event_name == 'pull_request'
        with:
          coverage-summary-path: ./coverage/coverage-summary.json
          summary-title: 'ðŸ’¯ Test Coverage'
          badge-title: Coverage
          create-new-comment: false
          junitxml-title: ðŸ˜Ž Tests Results
          junitxml-path: ./coverage/jest-junit.xml
          coverage-title: ðŸ‘€ Tests Details
          coverage-path: ./coverage/coverage.txt
          report-only-changed-files: true

  # ============================================
  # Job 5: All Checks Passed
  # ============================================
  all-checks-passed:
    name: âœ… All Checks Passed
    runs-on: ubuntu-latest
    needs: [expo-doctor, lint, type-check, test]
    if: always()
    steps:
      - name: âœ… Verify All Jobs Succeeded
        if: >
          needs.expo-doctor.result == 'success' &&
          needs.lint.result == 'success' &&
          needs.type-check.result == 'success' &&
          needs.test.result == 'success'
        run: echo "All CI checks passed successfully! ðŸŽ‰"

      - name: âŒ Some Jobs Failed
        if: >
          needs.expo-doctor.result != 'success' ||
          needs.lint.result != 'success' ||
          needs.type-check.result != 'success' ||
          needs.test.result != 'success'
        run: |
          echo "Some CI checks failed. Please review the logs above."
          exit 1
